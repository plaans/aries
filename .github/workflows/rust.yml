name: Aries

on: [push, pull_request]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - uses: actions-rs/cargo@v1
        with:
          command: test

  fmt:
    name: Rustfmt
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - run: rustup component add rustfmt
      - uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check

  solving:
    name: Solving
    runs-on: ubuntu-20.04
    env: # Make sure we have fast binaries and debuggable binaries
      CARGO_PROFILE_RELEASE_DEBUG: false
      CARGO_PROFILE_DEV_DEBUG: false
      CARGO_PROFILE_RELEASE_DEBUG_ASSERTIONS: true
      CARGO_PROFILE_DEV_OPT_LEVEL: 3
      CARGO_PROFILE_DEV_LTO: thin
      RUST_BACKTRACE: false
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - name: Install GNU parallel
        run: sudo apt-get install parallel
      - name: Get problems from LFS
        run: git lfs pull
      - name: SAT solving
        run: ./ci/sat.py debug
      - name: Jobshop solving
        run: ./ci/jobshop.py
      - name: GG solving
        run: ./ci/gg.py
      - name: LCP Solving (PDDL & HDDL)
        run: ./ci/lcp.sh

  up_proto_definition:
    name: Check for new protobuf definitions
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - name: Check for new protobuf definitions
        run: |
          # Download the latest protobuf definitions
          printf "Checking for new protobuf definitions...\n"
          curl https://raw.githubusercontent.com/aiplan4eu/unified-planning/master/unified_planning/grpc/unified_planning.proto > grpc/api/src/unified_planning.proto
          git diff --exit-code
  grpc:
    name: Solving (GRPC API)
    runs-on: ubuntu-20.04
    env: # Make sure we have fast binaries and debuggable binaries
      CARGO_PROFILE_RELEASE_DEBUG: false
      CARGO_PROFILE_DEV_DEBUG: false
      CARGO_PROFILE_RELEASE_DEBUG_ASSERTIONS: true
      CARGO_PROFILE_DEV_OPT_LEVEL: 3
      CARGO_PROFILE_DEV_LTO: thin
      RUST_BACKTRACE: false
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - name: LCP Solving (Unified Planning)
        run: ./ci/grpc.py

  clippy:
    name: Clippy
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - run: rustup component add clippy
      - uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: -- -D warnings

